{
  "poster": "data:image/png;base64,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",
  "knowledge": {
    "readme": "## 组合关系评分\n\n### 研究布局",
    "course": "\n\n- 自动监听剪切板，收集图片\n- 轮廓比较，结果越低，匹配越好\n\n"
  },
  "code": "// 画布大小\nlet _WIDTH = 240, _HEIGHT = 240;\n\n// 提示信息\nlet info, canvas, layout, imagesClass, classImages;\n\n// 所有图片\nvar imagesDict = {};\n\n// 存储图片特征\nvar features = [];\n\n// 图像数量\nvar index = -1;\n\n// 布局\nvar layoutStore = new Store('layout-data-test');\n\n// 分类模型\nvar dataset = new Store('dataset-layout-test');\nvar knnModel = Lab.ai.knnClassifier();\nknnModel.topk = 5;\nvar imgModel = new Lab.ai.Mobilenet();\nPromise.all([\n    knnModel.loadFromStore('test'),\n    imgModel.init()\n]).then(() => {\n    // knnModel.minDataset();\n    info.innerText = '开始使用';\n});\n\nfunction gui() {\n\n    //隐藏p5的画布\n    Lab.base.p5Show(false);\n    Lab.base.layout(0);\n    Lab.base.loading(0);\n\n    canvas = new Canvas(_WIDTH, _HEIGHT);\n    canvas.dblclick = opt => {\n        canvas.moveToTop(opt.target);\n    };\n\n    info = Lab.base.createBaseText('加载ing');\n\n    //打标\n    let good = Lab.base.createButton('正样本', () => {\n        let gt = new Store('good');\n        let data = {\n            img1: features[0].img.src,\n            img2: features[1].img.src,\n            img3: canvas.toDataURL(1)\n        }\n        gt.set(Lab.base.hash(data), data);\n    }, false);\n    let bad = Lab.base.createButton('负样本', () => {\n        let bt = new Store('bad');\n        let data = {\n            img1: features[0].img.src,\n            img2: features[1].img.src,\n            img3: canvas.toDataURL(1)\n        }\n        bt.set(Lab.base.hash(data), data);\n    }, false);\n    good.style.fontSize = '12px';\n    bad.style.fontSize = '12px';\n\n    let infoAndTag = Lab.base.createGroup(info, good, bad);\n    let datasetInfo = async () => {\n        info.innerText = `类别 ${index} ,共 ${Object.values(imagesDict).filter(f => f.index === index).length}`;\n    };\n    // 下一张组合\n    //创建图标\n    let refresh = Lab.base.createIcon('refresh', async () => {\n        if (!layout) {\n            layout = Array.from(canvas.getObjects(), o => {\n                const { left, top, width, height } = o.getBoundingRect();\n                return {\n                    left: left,\n                    top: top,\n                    width, height\n                }\n            });\n            layoutStore.set(Lab.base.hash(layout), layout);\n        };\n        canvas.reset();\n        await create();\n\n    }, false);\n\n    let addRectBtn = Lab.base.createIcon('plus', async () => {\n        if (layout) {\n            layout = null;\n            canvas.reset();\n            features = [];\n            index = 0;\n        } else {\n            index++;\n        };\n        let opacity = 0.1 * (canvas.getObjects().length + 1);\n        canvas.addRect({\n            width: 100,\n            height: 100,\n            fill: `rgba(255,0,0,${opacity})`,\n            lockMovementX: false,\n            lockScalingX: false,\n            lockScalingY: false,\n        }, true, true, false);\n        await datasetInfo();\n    }, false);\n\n    refresh.style.width = '50%';\n\n    // 排序\n    function sortImageClass(data = []) {\n        // console.log(classImages)\n        Array.from(data, c => {\n            let imgBtn = Lab.base.createButton('', () => {\n                // console.log(c, classImages)\n                let targetShape = c.shapeFeature;\n                data = Array.from(data, t => {\n                    var tShape = t.shapeFeature;\n                    let score = Lab.ai.shape.matchShape(targetShape, tShape);\n                    return Object.assign(t, { score });\n                });\n                data = data.sort((a, b) => a.score - b.score);\n                // console.log(classImages)\n                imagesClass.innerHTML = '';\n                sortImageClass(data);\n            }, false);\n            imgBtn.style.height = 'auto';\n            imgBtn.appendChild(c.img);\n            imagesClass.appendChild(imgBtn);\n        });\n    }\n    let test = Lab.base.createIcon('light', async () => {\n        let data = getClassOne(index);\n        imagesClass.innerHTML = '';\n        sortImageClass(data);\n    }, false);\n\n    let mainGroup = Lab.base.createGroup(\n        canvas.getElement(), infoAndTag,\n        Lab.base.createGroup(refresh, addRectBtn), test\n    );\n    mainGroup.layout('g37');\n    mainGroup.style.width = '80%';\n    Lab.base.add(\n        mainGroup\n    );\n\n    imagesClass = Lab.base.createGroup();\n    imagesClass.layout(1);\n    Lab.base.add(imagesClass);\n\n    // 清空图片\n    let clear = Lab.base.createIcon('clear', () => {\n        // 清空缓存\n        Lab.base.clipboard.clearStore('img');\n        layoutStore.clear();\n        dataset.clear();\n\n        for (let id in imagesDict) {\n            imagesDict[id].img.remove();\n        };\n        imagesDict = {};\n        info.innerText = '已清空';\n        canvas.reset();\n        layout = null;\n        index = -1;\n\n    }, false);\n    // 训练\n    let train = Lab.base.createIcon('play', async () => {\n        train.setAttribute('disabled', true);\n\n        let data = await new Store('good').getValues();\n        for (let d of data) {\n            let img = await Lab.base.createImage(d.img3);\n            let tensor = await feature(img);\n            knnModel.add(tensor, 'good');\n        }\n        data = await new Store('bad').getValues();\n        for (let d of data) {\n            let img = await Lab.base.createImage(d.img3);\n            let tensor = await feature(img);\n            knnModel.add(tensor, 'bad');\n        };\n        train.removeAttribute('disabled');\n        knnModel.save('test');\n        alert('完成训练');\n    }, false);\n\n    let btns = Lab.base.createGroup(train, clear);\n    train.style.width = '56px';\n    clear.style.width = '56px';\n    btns.layout(0);\n    Lab.base.add(btns);\n\n\n    // 监听剪切板\n    Lab.base.clipboard.listener('img', async (base64, id) => {\n\n        // // 轮廓提取\n        // imgProcess()\n        // 特征提取\n        let im = await Lab.base.createImage(base64);\n        let shapeFeature = imgProcess(im);\n        let imgFeature = (await feature(im.img)).arraySync();\n        let imo = {\n            id,\n            index,\n            shapeFeature,\n            imgFeature\n        }\n        dataset.set(id, imo);\n\n        imo.base64 = base64;\n        //创建图片\n        await addImg(imo);\n\n        await datasetInfo();\n    });\n\n    // 获取缓存\n    Lab.base.clipboard.getAllStore('img').then(async json => {\n        let datasetIds = await dataset.getJson();\n        layout = (await layoutStore.getValues()).filter(f => f && f.length > 0)[0];\n        // await dataset.clear();\n        // console.log(datasetIds)\n\n        let imgs = [];\n        // let count = 5;\n\n        for (let id in json) {\n            // if (count < 0) return loadImageByBatch(imgs, imgs.length);\n            // count--;\n\n            let base64 = json[id];\n\n            if (datasetIds.hasOwnProperty(id)) {\n                // console.log(datasetIds[id])\n                imgs.push({\n                    base64,\n                    index: datasetIds[id].index,\n                    shapeFeature: datasetIds[id].shapeFeature,\n                    imgFeature: datasetIds[id].imgFeature,\n                    id: id\n                });\n\n            };\n\n        };\n\n        loadImageByBatch(imgs, imgs.length);\n\n    });\n\n    // 分批加载\n    function loadImageByBatch(imgs = [], sum = 1) {\n\n        let bs = Array.from(new Array(8), i => imgs.pop()).filter(f => f);\n        // console.log(bs,sum)\n        Promise.all(\n            Array.from(bs, im => addImg(im))\n        ).then(() => {\n\n            if (imgs.length <= 0) {\n                Lab.base.loading(100);\n                info.innerText = `${Object.keys(imagesDict).length}张图`;\n            } else {\n                info.innerText = `${parseInt(100 * Object.keys(imagesDict).length / sum)}%`;\n                setTimeout(() => {\n                    loadImageByBatch(imgs, sum);\n                }, 1000 + Math.random() * 10)\n            }\n\n        });\n\n    }\n\n    // 图片 预处理\n    async function addImg(im) {\n        // let id = Lab.base.md5(url);\n        let id = im.id;\n        if (imagesDict[id] && imagesDict[id].index != null && imagesDict[id].index != -1) return;\n        let img = await Lab.base.createImage(im.base64);\n        img.style.width = \"88px\";\n        img.style.margin = \"8px\";\n        img.id = id;\n        // let cannyImg = await imgProcess(img);\n        // let { thresholdImg, res } = await threshold(img, 100, 100);\n        // let g = Lab.base.createGroup(img, cannyImg, thresholdImg);\n        imagesDict[id] = {\n            index: im.index,\n            img,\n            shapeFeature: im.shapeFeature,\n            imgFeature: im.imgFeature\n        };\n    }\n\n    // 合图\n    async function create() {\n        // var objects = canvas.exportJSON().objects;\n        if (layout) {\n            layout.forEach((t, i) => {\n                let im = randomOne(i);\n                if (im) canvas.addAndResizeImage(im.img, t);\n            });\n            // 合图后\n            let im = await Lab.base.createImage(canvas.toDataURL(1));\n            let score = await knnModel.predict(\n                await feature(im)\n            );\n            // let { res } = await threshold(im, 100, 100);\n            if (score && score.confidences) info.innerText = `评分:${score.confidences.good}`;\n        }\n    }\n}\n\n// 尝试下打标，把构图比较好的轮廓作为参考，比较轮廓\n// 抽取特征\nasync function feature(img) {\n    //img = await imgProcess(img);\n    let tensor = imgModel.infer(img);\n    return tensor\n}\n\nfunction imgProcess(img) {\n    // 轮廓提取\n    return Lab.ai.shape.findContoursForImg(img);\n}\n\n// // 边缘检测\n// async function imgProcess(img) {\n//     //创建画布\n//     let canvas = Lab.base.createCanvas(img.naturalWidth, img.naturalHeight, 'myCanvas', '', false);\n//     let src = cv.imread(img);\n\n//     // 缩放为100x100方形\n//     let rdst = new cv.Mat();\n//     let dsize = new cv.Size(100, 100);\n//     // You can try more different parameters\n//     cv.resize(src, rdst, dsize, 0, 0, cv.INTER_AREA);\n\n//     let dst = new cv.Mat();\n//     cv.cvtColor(rdst, rdst, cv.COLOR_RGB2GRAY, 0);\n//     // You can try more different parameters\n//     cv.Canny(rdst, dst, 50, 100, 3, false);\n\n//     cv.imshow(canvas, dst);\n\n//     let url = canvas.toDataURL();\n//     let cannyImg = await Lab.base.createImage(url);\n//     //img.insertAdjacentElement('afterend',cannyImg);\n//     // console.log(cannyImg);\n//     src.delete();\n//     rdst.delete();\n//     dst.delete();\n//     canvas.remove();\n//     return cannyImg;\n// }\n\n// // 阈值分割\n// async function threshold(img, w, h) {\n//     //创建画布\n//     let canvas = Lab.base.createCanvas(img.naturalWidth, img.naturalHeight, 'myCanvas', '', false);\n//     let src = cv.imread(img);\n//     cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY, 0);\n\n//     // 缩放为100x100方形\n//     let rdst = new cv.Mat();\n//     let dsize = new cv.Size(w, h);\n//     // You can try more different parameters\n//     cv.resize(src, rdst, dsize, 0, 0, cv.INTER_AREA);\n\n//     let dst = new cv.Mat();\n//     // You can try more different parameters\n//     cv.threshold(rdst, dst, 10, 100, cv.THRESH_BINARY);\n//     cv.imshow(canvas, dst);\n\n//     let url = canvas.toDataURL();\n//     let thresholdImg = await Lab.base.createImage(url);\n\n//     // console.log(area(dst))\n//     let res = area(dst);\n//     // res=res/(w*h);\n\n//     rdst.delete();\n//     src.delete();\n//     canvas.remove();\n//     //dst.delete();\n//     return { thresholdImg, res: res };\n// }\n\n// // 轮廓\n// function area(src) {\n//     let values = [];\n//     let contours = new cv.MatVector();\n//     let hierarchy = new cv.Mat();\n//     cv.findContours(src, contours, hierarchy, cv.RETR_CCOMP, cv.CHAIN_APPROX_SIMPLE);\n\n//     for (let i = 0; i < contours.size(); i++) {\n//         let cnt = contours.get(i);\n//         let area = cv.contourArea(cnt, false);\n//         values.push({\n//             area: area,\n//             cnt: cnt\n//         });\n//     };\n//     values = values.sort((b, a) => a.area - b.area)\n//     src.delete();\n//     contours.delete();\n//     hierarchy.delete();\n//     return values[0]\n// }\n\n// //  比较两个轮廓\n// function compare(cnt1, cnt2) {\n//     let result = cv.matchShapes(cnt1, cnt2, 1, 0);\n//     return result;\n// }\n\n\nfunction getClassOne(i) {\n    let imgs = [];\n    for (let id in imagesDict) {\n        let img = imagesDict[id];\n        if (img.index === i) {\n            img.shapeFeature = Lab.ai.shape.contoursLoad(img.shapeFeature);\n            imgs.push(img);\n        };\n    };\n    return imgs\n}\n\nfunction randomOne(i) {\n    let imgs = getClassOne(i);\n    return imgs[parseInt(Math.random() * imgs.length)];\n}",
  "code_length": 75,
  "size": [
    410,
    675
  ],
  "extname": "designlabplugin",
  "version": "0.1.1",
  "package_id": "3bc909fb241f493dde9ba4db0ed2b5254cad0b6c",
  "create_time": 1617362020339
}