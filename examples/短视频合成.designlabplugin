{
  "poster": "data:image/png;base64,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",
  "knowledge": {
    "readme": "## 短视频合成\n\n\n### 从本地文件合成短视频，并添加音乐",
    "course": ""
  },
  "code": "//Hello AI world!\nvar videos = {};\nlet videoObjId;\nvar store = new Store('video_create_by_shadow');\nvar storeKey = (new Date()).getTime().toString();\nvar outputVideo;\n\n// 合成预览\n// 540*960\nvar _WIDTH = Math.min(parseInt(window.innerWidth * 0.8), 240),\n    _HEIGHT = parseInt(_WIDTH * 16 / 9),\n    _SCALE = 4;\n\n// UI\nlet pc, info;\n\n// 界面\nlet audioGroup, framesGroup;\nasync function gui() {\n    //隐藏p5的画布\n    Lab.base.p5Show(false);\n    Lab.base.layout(1);\n\n    let refreshBtn= Lab.base.createIcon(\"refresh\", _newVideo, false);\n    let createBtn = Lab.base.createIcon(\"play\", _createVideo, false);\n    info = Lab.base.createBaseText('开始合成吧！');\n    let downloadBtn = Lab.base.createIcon('save', _downloadVideo, false);\n    let group = Lab.base.createGroup(refreshBtn,createBtn, downloadBtn, info);\n    group.layout(2);\n    Lab.base.add(group);\n\n    audioGroup = Lab.base.createGroup(Lab.base.createIcon('music', () => {\n        Lab.base.toast('推荐背景音乐，待开发');\n    }, false));\n    audioGroup.layout(2);\n    Lab.base.add(audioGroup);\n\n    framesGroup = Lab.base.createGroup();\n    framesGroup.style.padding = '24px';\n    framesGroup.layout(2);\n    framesGroup.children = {};\n    Lab.base.add(framesGroup);\n\n    pc = new Canvas(_WIDTH, _HEIGHT, false, false);\n    outputVideo = await Lab.base.createVideo('', false);\n\n    outputVideo.style.width = _WIDTH + 'px';\n    outputVideo.style.height = _HEIGHT + 'px';\n\n    let previewGroup = Lab.base.createGroup(pc.getElement(), outputVideo);\n    previewGroup.layout(0);\n    Lab.base.add(previewGroup);\n\n    createAddCard();\n\n    // 字幕生成\n    const createTextImageAndUpdate = (text, style) => {\n        let id = Lab.base.hash({ text, style });\n        console.log(videos, videoObjId)\n        if (id != videos[videoObjId].textId) {\n            videos[videoObjId] = Object.assign(videos[videoObjId], {\n                textId: id,\n                text,\n                textImage: createTextImage(text, style)\n            })\n        }\n    };\n    // 绑定事件\n    pc.onModified = (opt, json) => {\n        // 文本修改信息\n        if (opt.target.type === 'textbox') {\n            let style = textStyleExtract(opt.target);\n            const { text } = opt.target;\n            createTextImageAndUpdate(text, style);\n        };\n        // 布局信息\n        updateData(videoObjId, json);\n        // 更新预览图\n        updatePreviewImg(videoObjId);\n    };\n\n\n};\n\nasync function createAddCard() {\n    let addBtn = Lab.base.createIcon(\"plus\", _addVideo, false);\n    let imBtn = Lab.base.createButton(\"\", () => { }, false);\n    imBtn.appendChild(addBtn);\n    addBtn.style.width = '56px';\n    addBtn.style.borderRadius = 0;\n    addBtn.style.color = '#4a4a4a';\n    addBtn.style.background = 'rgba(255,255,255,0.1)';\n    addBtn.style.height = `${_HEIGHT * 56 / _WIDTH}px`\n    addBtn.style.margin = '2px';\n    imBtn.style = `\n    height: auto;\n    background: #eee;\n    border-radius: 8px;\n    padding: 0;`;\n    framesGroup.appendChild(imBtn);\n}\n\n\n// 添加素材\nasync function _addVideo() {\n    let labVideo = Lab.base.createShortVideoInput();\n\n    // 帧数据\n    labVideo = await baseData(labVideo);\n\n    videos[labVideo.id] = labVideo;\n\n    if (labVideo.type === 'audio') {\n        await baseAddBackgroundAudio(labVideo);\n    } else {\n        await baseAddVideo(labVideo);\n    }\n\n    updateData(labVideo.id);\n\n}\n// 结果\nasync function _createVideo() {\n    info.innerText = '正在合成ing';\n    let finishData = createVideoData();\n    outputVideo.src = await Lab.video.mergeAll(finishData, (progress) => {\n        info.innerText = progress.toFixed(2);\n    });\n    Lab.base.toast('完成' + outputVideo.src);\n    _save();\n    outputVideo.play();\n}\n\nfunction _downloadVideo() {\n    Lab.base.saveDialog(outputVideo.src);\n}\nasync function _newVideo(){\n   await store.clear();\n   window.location.reload();\n}\n\n\n// 关键帧数据\nconst createFrameData = (labVideo) => {\n    let { index, url, type, layout, createTime, id, text, textImage } = labVideo;\n    if (!((index != null || index != undefined) && typeof index === 'number')) index = Object.keys(videos).length;\n    let obj = {\n        index,\n        type,\n        url,\n        text,\n        textImage,\n        layout,\n        createTime: createTime || (new Date()).getTime()\n    };\n    if (!id) {\n        obj.id = Lab.base.hash(obj)\n    } else {\n        obj.id = id;\n    };\n\n    return obj;\n};\n\nconst createTextImage = (text, style) => {\n    let tc = new Canvas(_WIDTH, _HEIGHT, true, false);\n    tc.addText(text, style, false, false);\n    // console.log(style)\n    //TODO  调试\n    // document.body.appendChild(tc.getElement())\n    return tc.toDataURL(_SCALE);\n};\n\n// 计算字幕的停留时间\nconst getTextLoop = text => {\n    text = text || '';\n    return Math.max(parseInt(text.length / 2.5), 5)\n}\n\n// 取布局数据\nconst getLayout = (obj) => {\n    let { top, left, width, height, scaleX, scaleY, angle } = obj;\n    scaleX = scaleX || 1;\n    scaleY = scaleY || 1;\n    return {\n        angle: angle || 0,\n        top: parseInt(top * _SCALE),\n        left: parseInt(left * _SCALE),\n        width: Math.min(parseInt(width * _SCALE * scaleX), _WIDTH * _SCALE),\n        height: Math.min(parseInt(height * _SCALE * scaleY), _HEIGHT * _SCALE)\n    }\n};\n\n\n// 文本的样式\nconst textStyleExtract = obj => {\n    let res;\n    if (obj) {\n        const { top,\n            left,\n            width,\n            height,\n            fill,\n            fontSize,\n            charSpacing,\n            fontFamily,\n            angle,\n            scaleX,\n            scaleY\n        } = obj;\n        res = {\n            top,\n            left,\n            width,\n            height,\n            fill,\n            fontSize,\n            charSpacing: charSpacing || 0,\n            fontFamily,\n            angle: angle || 0,\n            scaleX: scaleX || 1,\n            scaleY: scaleY || 1\n        }\n    } else {\n        res = {\n            top: parseInt(_HEIGHT * 0.1),\n            left: 0,\n            width: _WIDTH,\n            fontSize: parseInt(_HEIGHT * 0.05),\n            fill: \"white\",\n            fontFamily: 'monospace'\n        }\n    }\n    return res\n\n}\n\n// 内容样式\n// 计算居中\nconst contentStyleExtract = (obj, element) => {\n    let res;\n    if (obj) {\n        // width,height是元素真实的尺寸，通过scale来缩放成最终的高宽\n        const { left, top, width, height, angle, scaleX, scaleY } = obj;\n        // console.log(width, height, scaleX, scaleY)\n        res = {\n            left, top,\n            width, height,\n            scaleX: scaleX || 1, scaleY: scaleY || 1,\n            angle: angle || 0\n        }\n    } else {\n        let width = element.width, height = element.height;\n        let scale = _WIDTH / element.width;\n        if (width < _WIDTH) {\n            scale = element.width / _WIDTH;\n        };\n\n        scale = parseFloat(scale.toFixed(2));\n\n        res = {\n            left: parseInt((_WIDTH - width * scale) / 2),\n            top: parseInt((_HEIGHT - height * scale) / 2),\n            width, height,\n            scaleX: scale, scaleY: scale,\n            angle: 0\n        }\n        // console.log(res)\n    }\n    return res\n}\n\nconst getContentStyle = (layout, element) => {\n    let target = layout ? layout.filter(f => f.type === 'image')[0] : null;\n    let res = contentStyleExtract(target, element);\n    // console.log(res)\n    return res\n};\n\nconst getTextStyle = (layout) => {\n    let target = layout ? layout.filter(f => f.type === 'textbox')[0] : null;\n    let res = textStyleExtract(target);\n    return res\n}\n\n// 准备绘制 字幕的数据\nconst getTextAndStyle = labVideo => {\n    // 文字输入\n    let style = getTextStyle(labVideo.layout),\n        text = labVideo.type == \"audio\" ? \"背景音乐\" : '字幕';\n    // console.log(textStyle)\n    if (labVideo.text) {\n        text = labVideo.text;\n    };\n    return {\n        element: text,\n        style\n    }\n}\n// 准备绘制 内容的数据\nconst getContentAndStyle = async labVideo => {\n    // 元素\n    let element;\n    if (labVideo.type == \"video\") {\n        element = await Lab.base.createVideo(labVideo.url, false);\n    } else if (labVideo.type == \"img\") {\n        element = await Lab.base.createImage(labVideo.url);\n    };\n    // 样式\n    let style = getContentStyle(labVideo.layout, element);\n    return {\n        element,\n        style\n    }\n}\n\nasync function createPreviewImg(id) {\n    let base64 = pc.toDataURL(1);\n\n    //创建图片\n    let im = await Lab.base.createImage(base64);\n    im.style.width = '56px';\n    im.style.margin = '2px';\n    im.id = id;\n    let imBtn = Lab.base.createButton(\"\", async () => {\n        videoObjId = id;\n        await baseAddVideo(videos[id], false);\n    }, false);\n    imBtn.appendChild(im);\n    imBtn.style = `\n    height: auto;\n    background: #eee;\n    border-radius: 8px;\n    padding: 0;`;\n    framesGroup.appendChild(imBtn);\n    framesGroup.children[id] = im;\n    videos[id].preview = im.src;\n}\n\nfunction updatePreviewImg(id) {\n    let base64 = pc.toDataURL(1);\n    //更新图片\n    if(framesGroup.children[id])framesGroup.children[id].src = base64;\n    videos[id].preview = base64;\n}\n\n\nfunction createVideoData() {\n    // 背景音乐\n    let backgroudAudio = null;\n    let _videos = videos2array();\n    var videosNew = Array.from(_videos, v => {\n        if (v && v.url) {\n            let index = v.index;\n            let textImage = null;\n            let content = null;\n            // console.log(v)\n            if (v.type === 'audio') {\n                backgroudAudio = v;\n            } else {\n                Array.from(v.layout || [], l => {\n                    //console.log(l)\n                    if (l.type == 'textbox') {\n                        textImage = {\n                            text: v.text,\n                            base64: v.textImage,\n                            loop: getTextLoop(v.text),\n                            layout: getLayout(l)\n                        };\n                        if (!v.text) textImage = null;\n                    } else if (l.type == 'image') {\n\n                        content = {\n                            type: v.type,\n                            url: v.url,\n                            // loop: 5,\n                            layout: getLayout(l)\n                        };\n                    };\n\n                });\n            }\n            return (content || textImage) ? {\n                index,\n                content,\n                textImage\n            } : null\n        }\n    }).filter(f => f);\n    let finishData = {\n        width: _WIDTH * _SCALE,\n        height: _HEIGHT * _SCALE,\n        // 按照index升序\n        frames: videosNew.sort((a, b) => a.index - b.index),\n        backgroudAudio: backgroudAudio\n    };\n    // console.log(finishData)\n    return finishData\n}\n\n// 更新布局layout\nconst updateLayout = json => {\n    return Array.from(json.objects, o => {\n        // console.log(o)\n        let no = { left: o.left, top: o.top, width: o.width, height: o.height, type: o.type };\n        if (o.type == 'textbox') {\n            no = Object.assign(no, textStyleExtract(o))\n        } else if (o.type == 'image') {\n            no = Object.assign(no, contentStyleExtract(o))\n        }\n        return no\n    });\n};\n\nasync function baseData(labVideo) {\n    // 帧数据\n    let videoObj = createFrameData(labVideo);\n    labVideo.type !== 'audio'?videoObjId = videoObj.id:null;\n    // 去重？?\n    // if (Array.from(videos, v => v.id).includes(videoObj.id)) return console.log(labVideo);\n    if (labVideo.type == 'audio') {\n        //背景音乐\n        let element = await Lab.base.createaAudio(labVideo.url, false);\n        videoObj = Object.assign(videoObj, {\n            duration: element.duration,\n            startTime: 0,\n            loop: 5\n        })\n    };\n    return videoObj\n}\n\nfunction updateData(id, json) {\n    // console.log('更新数据',videos[id],json)\n    // console.log(updateLayout(json))\n    videos[id] = Object.assign(videos[id], {\n        layout: updateLayout(json || pc.exportJSON())\n    })\n    _save();\n}\n\nasync function baseAddBackgroundAudio(labVideo) {\n    if (audioGroup.querySelector('audio')) audioGroup.querySelector('audio').remove();\n    audioGroup.appendChild(await Lab.base.createaAudio(labVideo.url, false));\n}\n\n\nasync function baseAddVideo(labVideo, isNew = true) {\n    // console.log(labVideo)\n    //  console.log(labVideo.preview)\n    if (labVideo) {\n\n        //添加到画布 \n        pc.reset();\n        // 背景\n        pc.addRect({\n            width: _WIDTH,\n            height: _HEIGHT,\n            fill: 'black',\n            stroke: 'black'\n        }, false);\n\n        // 内容\n        let { element, style } = await getContentAndStyle(labVideo);\n        // console.log(element)\n        if (labVideo.type == \"video\") {\n            pc.addVideo(element,\n                Object.assign(style, {\n                    objectCaching: false\n                }));\n        } else if (labVideo.type == \"img\") {\n            pc.addImg(element, style);\n        };\n\n        // 字幕\n        let { element: text, style: ts } = getTextAndStyle(labVideo);\n        pc.addText(text, ts);\n\n        //最后\n        // 创建预览图片\n        if (isNew === true) await sleep(() => createPreviewImg(labVideo.id), 200);\n\n    };\n};\n\nfunction sleep(fn, t = 500) {\n    return new Promise((resolve, reject) => {\n        setTimeout(() => {\n            if (fn) fn();\n            resolve();\n        }, t);\n    });\n}\n\n// 缓存\nstore.getValues().then(async vs => {\n    // console.log(vs)\n    await store.clear();\n    if (vs[0]) {\n        _WIDTH = vs[0].width;\n        _HEIGHT = vs[0].height;\n        _SCALE = vs[0].scale;\n        if (outputVideo && outputVideo.src) (outputVideo.src = vs[0].outputVideo) && outputVideo.play();\n        let ds = (vs[0].videos || []);\n        ds = ds.sort((a, b) => a.index - b.index);\n        for (let i = 0; i < ds.length; i++) {\n            videos[ds[i].id] = ds[i];\n            if (ds[i].type === 'audio') {\n                await baseAddBackgroundAudio(ds[i]);\n            } else {\n                await baseAddVideo(ds[i]);\n            };\n            videoObjId = ds[i].id;\n        };\n        _save();\n    }\n});\n// videos object转array\nfunction videos2array() {\n    let vs = [];\n    for (let id in videos) {\n        vs.push(videos[id])\n    };\n    vs = vs.sort((a, b) => a.index - b.index);\n    return vs;\n}\n// 保存\nfunction _save() {\n    let vs = videos2array();\n    store.set(storeKey, {\n        videos: vs,\n        width: _WIDTH,\n        height: _HEIGHT,\n        scale: _SCALE,\n        outputVideo: outputVideo && outputVideo.src&&outputVideo.src.match('.mp4') ? outputVideo.src : null\n    });\n}\n\n",
  "code_length": 127,
  "size": [
    682,
    790
  ],
  "extname": "designlabplugin",
  "version": "0.1.0",
  "package_id": "a626a8e0317cf9809362a3829ce74dbe7171f06e",
  "create_time": 1614180215691
}