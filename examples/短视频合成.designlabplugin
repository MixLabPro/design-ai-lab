{
  "poster": "data:image/png;base64,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",
  "knowledge": {
    "readme": "## 短视频合成\n\n\n### 从本地文件合成短视频，并添加音乐",
    "course": ""
  },
  "code": "//Hello AI world!\nvar videos = {};\nlet videoObjId;\nvar store = new Store('video_create_by_shadow');\nvar storeKey = (new Date()).getTime().toString();\nvar outputVideo;\n\n// 合成预览\n// 540*960\nvar _WIDTH = Math.min(parseInt(window.innerWidth * 0.8), 240),\n    _HEIGHT = parseInt(_WIDTH * 16 / 9),\n    _SCALE = 4,\n    _OUTPUTDIR = null;\n\n// UI\nlet pc, info;\n\n// 界面\nlet audioGroup, framesGroup;\nasync function gui() {\n    //隐藏p5的画布\n    Lab.base.p5Show(false);\n    Lab.base.layout(0);\n\n    let refreshBtn = Lab.base.createIcon(\"refresh\", _newVideo, false);\n    let createBtn = Lab.base.createIcon(\"play\", _createVideo, false);\n    info = Lab.base.createBaseText('开始合成吧！');\n    // let downloadBtn = Lab.base.createIcon('save', _downloadVideo, false);\n    let mainBtns = Lab.base.createGroup(info, createBtn);\n    mainBtns.layout(6);\n    mainBtns.style.width = '60%';\n    let setupBtn = Lab.base.createButton('设置路径', _setupFilePath, false);\n    let header = Lab.base.createGroup(mainBtns, refreshBtn, setupBtn);\n    header.layout(6);\n    Lab.base.add(header);\n\n    audioGroup = Lab.base.createGroup(Lab.base.createIcon('music', () => {\n        Lab.base.toast('推荐背景音乐，待开发');\n    }, false));\n    audioGroup.layout(6);\n    Lab.base.add(audioGroup);\n\n    framesGroup = Lab.base.createGroup();\n    framesGroup.style.padding = '24px';\n    framesGroup.layout(6);\n\n    //framesGroup.children = {};\n    Lab.base.add(framesGroup);\n\n    let editBtn = Lab.base.createIcon(\"square\", _newRect, false);\n    let textBtn = Lab.base.createIcon(\"comment\", _newText, false);\n    let editGroup = Lab.base.createGroup(editBtn, textBtn);\n    editGroup.layout(6);\n    Lab.base.add(editGroup);\n\n    pc = new Canvas(_WIDTH, _HEIGHT, false, false);\n\n\n    let previewGroup = Lab.base.createGroup(pc.getElement());\n    previewGroup.layout(0);\n    Lab.base.add(previewGroup);\n\n    createAddCard();\n\n    // 字幕生成\n    const createTextImageAndUpdate = (text, style) => {\n        let id = Lab.base.hash({ text, style });\n        console.log(videos, videoObjId)\n        if (id != videos[videoObjId].textId) {\n            videos[videoObjId] = Object.assign(videos[videoObjId], {\n                textId: id,\n                text,\n                textImage: createTextImage(text, style)\n            })\n        }\n    };\n    // 绑定事件\n    pc.onModified = (opt, json) => {\n        // 文本修改信息\n        if (opt.target.type === 'textbox') {\n            let style = textStyleExtract(opt.target);\n            const { text } = opt.target;\n            createTextImageAndUpdate(text, style);\n        };\n        // 布局信息\n        updateData(videoObjId, json);\n        // 更新预览图\n        updatePreviewImg(videoObjId);\n    };\n\n\n};\n\nasync function createVideoPreview(url) {\n    outputVideo = await Lab.base.createVideo(url,\n        false);\n    outputVideo.style.width = _WIDTH + 'px';\n    outputVideo.style.height = _HEIGHT + 'px';\n    outputVideo.play();\n}\n\nasync function createAddCard() {\n    let addBtn = Lab.base.createIcon(\"plus\", _addVideo, false);\n    let imBtn = Lab.base.createButton(\"\", () => { }, false);\n    imBtn.appendChild(addBtn);\n    addBtn.style.width = '56px';\n    addBtn.style.borderRadius = 0;\n    addBtn.style.color = '#4a4a4a';\n    addBtn.style.background = 'rgba(255,255,255,0.1)';\n    addBtn.style.height = `${_HEIGHT * 56 / _WIDTH}px`\n    addBtn.style.margin = '2px';\n    imBtn.style = `\n    height: auto;\n    background: #eee;\n    border-radius: 8px;\n    padding: 0;`;\n    framesGroup.appendChild(imBtn);\n}\n\n\n// 添加素材\nasync function _addVideo() {\n    let labVideo = Lab.base.createShortVideoInput();\n\n    // 帧数据\n    labVideo = await baseData(labVideo);\n\n    videos[labVideo.id] = labVideo;\n\n    if (labVideo.type === 'audio') {\n        await baseAddBackgroundAudio(labVideo);\n    } else {\n        await baseAddVideo(labVideo);\n    }\n\n    updateData(labVideo.id);\n\n}\n// 结果\nasync function _createVideo() {\n    if (!_OUTPUTDIR) _setupFilePath() ;\n    if(!_OUTPUTDIR)return\n    info.innerText = '正在合成ing';\n    let finishData = createVideoData();\n    if (finishData.frames.length > 0) {\n        Lab.base.loading(0);\n        let src = await Lab.video.mergeAll(finishData, (progress) => {\n            info.innerText = progress.toFixed(2);\n        });\n        await createVideoPreview(src);\n        Lab.base.loading(100);\n        // Lab.base.toast('完成' + outputVideo.src);\n        _save();\n    }\n\n}\n\nfunction _setupFilePath() {\n    // console.log('filePath')\n    let filePath = Lab.base.getFilePath(2);\n    if (filePath && filePath[0]) {\n        _OUTPUTDIR = filePath[0];\n        Lab.video.newDirname = _OUTPUTDIR;\n    }\n    return _OUTPUTDIR\n    // console.log(filePath)\n}\nasync function _newVideo() {\n    await store.clear();\n    Lab.base.clear();\n    gui();\n}\n\nfunction _newRect() {\n    pc.addRect({\n        left: 0,\n        top: 0,\n        width: _WIDTH,\n        height: _WIDTH,\n        fill: 'rgba(0,255,0,0.3)',\n        lockMovementX: false,\n        lockRotation: false,\n        lockScalingX: false,\n        lockScalingY: false,\n    }, true, true);\n}\nfunction _newText() {\n    pc.addText('TEXT', getTextStyle());\n}\n\n// 关键帧数据\nconst createFrameData = (labVideo) => {\n    let { index, url, type, layout, createTime, id, text, textImage } = labVideo;\n    if (!((index != null || index != undefined) && typeof index === 'number')) index = Object.keys(videos).length;\n    let obj = {\n        index,\n        type,\n        url,\n        text,\n        textImage,\n        layout,\n        createTime: createTime || (new Date()).getTime()\n    };\n    if (!id) {\n        obj.id = Lab.base.hash(obj)\n    } else {\n        obj.id = id;\n    };\n\n    return obj;\n};\n\nconst createTextImage = (text, style) => {\n    let tc = new Canvas(_WIDTH, _HEIGHT, true, false);\n    tc.addText(text, style, false, false);\n    // console.log(style)\n    //TODO  调试\n    // document.body.appendChild(tc.getElement())\n    return tc.toDataURL(_SCALE);\n};\n\n// 计算字幕的停留时间\nconst getTextLoop = text => {\n    text = text || '';\n    return Math.max(parseInt(text.length / 2.5), 5)\n}\n\n// 取布局数据\nconst getLayout = (obj) => {\n    let { top, left, width, height, scaleX, scaleY, angle } = obj;\n    scaleX = scaleX || 1;\n    scaleY = scaleY || 1;\n    return {\n        angle: angle || 0,\n        top: parseInt(top * _SCALE),\n        left: parseInt(left * _SCALE),\n        width: Math.min(parseInt(width * _SCALE * scaleX), _WIDTH * _SCALE),\n        height: Math.min(parseInt(height * _SCALE * scaleY), _HEIGHT * _SCALE)\n    }\n};\n\n\n// 文本的样式\nconst textStyleExtract = obj => {\n    let res;\n    if (obj) {\n        const { top,\n            left,\n            width,\n            height,\n            fill,\n            fontSize,\n            charSpacing,\n            fontFamily,\n            angle,\n            scaleX,\n            scaleY\n        } = obj;\n        res = {\n            top,\n            left,\n            width,\n            height,\n            fill,\n            fontSize,\n            charSpacing: charSpacing || 0,\n            fontFamily,\n            angle: angle || 0,\n            scaleX: scaleX || 1,\n            scaleY: scaleY || 1\n        }\n    } else {\n        res = {\n            top: parseInt(_HEIGHT * 0.1),\n            left: 0,\n            width: _WIDTH,\n            fontSize: parseInt(_HEIGHT * 0.05),\n            fill: \"white\",\n            fontFamily: 'monospace'\n        }\n    }\n    return res\n\n}\n\n// 内容样式\n// 计算居中\nconst contentStyleExtract = (obj, element) => {\n    let res;\n    if (obj) {\n        // width,height是元素真实的尺寸，通过scale来缩放成最终的高宽\n        const { left, top, width, height, angle, scaleX, scaleY } = obj;\n        // console.log(width, height, scaleX, scaleY)\n        res = {\n            left, top,\n            width, height,\n            scaleX: scaleX || 1, scaleY: scaleY || 1,\n            angle: angle || 0\n        }\n    } else {\n        let width = element.width, height = element.height;\n        let scale = _WIDTH / element.width;\n        if (width < _WIDTH) {\n            scale = element.width / _WIDTH;\n        };\n\n        scale = parseFloat(scale.toFixed(2));\n\n        res = {\n            left: parseInt((_WIDTH - width * scale) / 2),\n            top: parseInt((_HEIGHT - height * scale) / 2),\n            width, height,\n            scaleX: scale, scaleY: scale,\n            angle: 0\n        }\n        // console.log(res)\n    }\n    return res\n}\n\nconst getContentStyle = (layout, element) => {\n    let target = layout ? layout.filter(f => f.type === 'image')[0] : null;\n    let res = contentStyleExtract(target, element);\n    // console.log(res)\n    return res\n};\n\nconst getTextStyle = (layout) => {\n    let target = layout ? layout.filter(f => f.type === 'textbox')[0] : null;\n    let res = textStyleExtract(target);\n    return res\n}\n\n// 准备绘制 字幕的数据\nconst getTextAndStyle = labVideo => {\n    // 文字输入\n    let style = getTextStyle(labVideo.layout),\n        text = null;\n    // console.log(textStyle)\n    if (labVideo.text) {\n        text = labVideo.text;\n    };\n    return {\n        element: text,\n        style\n    }\n}\n// 准备绘制 内容的数据\nconst getContentAndStyle = async labVideo => {\n    // 元素\n    let element;\n    if (labVideo.type == \"video\") {\n        element = await Lab.base.createVideo(labVideo.url, false);\n    } else if (labVideo.type == \"img\") {\n        element = await Lab.base.createImage(labVideo.url);\n    };\n    // 样式\n    let style = getContentStyle(labVideo.layout, element);\n    return {\n        element,\n        style\n    }\n}\n\nasync function createPreviewImg(id) {\n    let base64 = pc.toDataURL(1);\n\n    //创建图片\n    let im = await Lab.base.createImage(base64);\n    im.style.width = '56px';\n    im.style.margin = '2px';\n    im.id = id;\n    let imBtn = Lab.base.createButton(\"\", async () => {\n        videoObjId = id;\n        await baseAddVideo(videos[id], false);\n    }, false);\n    imBtn.appendChild(im);\n    imBtn.style = `\n    height: auto;\n    background: #eee;\n    border-radius: 8px;\n    padding: 0;`;\n    framesGroup.appendChild(imBtn);\n    framesGroup.children[id] = im;\n    videos[id].preview = im.src;\n}\n\nfunction updatePreviewImg(id) {\n    let base64 = pc.toDataURL(1);\n    //更新图片\n    if (framesGroup.children[id]) framesGroup.children[id].src = base64;\n    videos[id].preview = base64;\n}\n\n\nfunction createVideoData() {\n    // 背景音乐\n    let backgroudAudio = null;\n    let _videos = videos2array();\n    var videosNew = Array.from(_videos, v => {\n        if (v && v.url) {\n            let index = v.index;\n            let textImage = null;\n            let content = null;\n            // console.log(v)\n            if (v.type === 'audio') {\n                backgroudAudio = v;\n            } else {\n                Array.from(v.layout || [], l => {\n                    //console.log(l)\n                    if (l.type == 'textbox') {\n                        textImage = {\n                            text: v.text,\n                            base64: v.textImage,\n                            loop: getTextLoop(v.text),\n                            layout: getLayout(l)\n                        };\n                        if (!v.text) textImage = null;\n                    } else if (l.type == 'image') {\n\n                        content = {\n                            type: v.type,\n                            url: v.url,\n                            // loop: 5,\n                            layout: getLayout(l)\n                        };\n                    };\n\n                });\n            }\n            return (content || textImage) ? {\n                index,\n                content,\n                textImage\n            } : null\n        }\n    }).filter(f => f);\n    let finishData = {\n        width: _WIDTH * _SCALE,\n        height: _HEIGHT * _SCALE,\n        // 按照index升序\n        frames: videosNew.sort((a, b) => a.index - b.index),\n        backgroudAudio: backgroudAudio\n    };\n    // console.log(finishData)\n    return finishData\n}\n\n// 更新布局layout\nconst updateLayout = json => {\n    return Array.from(json.objects, o => {\n        // console.log(o)\n        let no = { left: o.left, top: o.top, width: o.width, height: o.height, type: o.type };\n        if (o.type == 'textbox') {\n            no = Object.assign(no, textStyleExtract(o))\n        } else if (o.type == 'image') {\n            no = Object.assign(no, contentStyleExtract(o))\n        }\n        return no\n    });\n};\n\nasync function baseData(labVideo) {\n    // 帧数据\n    let videoObj = createFrameData(labVideo);\n    labVideo.type !== 'audio' ? videoObjId = videoObj.id : null;\n    // 去重？?\n    // if (Array.from(videos, v => v.id).includes(videoObj.id)) return console.log(labVideo);\n    if (labVideo.type == 'audio') {\n        //背景音乐\n        let element = await Lab.base.createaAudio(labVideo.url, false);\n        videoObj = Object.assign(videoObj, {\n            duration: element.duration,\n            startTime: 0,\n            loop: 5\n        })\n    };\n    return videoObj\n}\n\nfunction updateData(id, json) {\n    // console.log('更新数据',videos[id],json)\n    // console.log(updateLayout(json))\n    videos[id] = Object.assign(videos[id], {\n        layout: updateLayout(json || pc.exportJSON())\n    })\n    _save();\n}\n\nasync function baseAddBackgroundAudio(labVideo) {\n    if (audioGroup.querySelector('audio')) audioGroup.querySelector('audio').remove();\n    audioGroup.appendChild(await Lab.base.createaAudio(labVideo.url, false));\n}\n\n\nasync function baseAddVideo(labVideo, isNew = true) {\n    // console.log(labVideo)\n    //  console.log(labVideo.preview)\n    if (labVideo) {\n\n        //添加到画布 \n        pc.reset();\n        // 背景\n        pc.addRect({\n            width: _WIDTH,\n            height: _HEIGHT,\n            fill: 'black',\n            stroke: 'black'\n        }, false);\n\n        // 内容\n        let { element, style } = await getContentAndStyle(labVideo);\n        // console.log(element)\n        if (labVideo.type == \"video\") {\n            pc.addVideo(element,\n                Object.assign(style, {\n                    objectCaching: false\n                }));\n        } else if (labVideo.type == \"img\") {\n            pc.addImg(element, style);\n        };\n\n        // 字幕\n        let { element: text, style: ts } = getTextAndStyle(labVideo);\n        if (text) pc.addText(text, ts);\n\n        //最后\n        // 创建预览图片\n        if (isNew === true) await sleep(() => createPreviewImg(labVideo.id), 200);\n\n    };\n};\n\nfunction sleep(fn, t = 500) {\n    return new Promise((resolve, reject) => {\n        setTimeout(() => {\n            if (fn) fn();\n            resolve();\n        }, t);\n    });\n}\n\n// 缓存\nstore.getValues().then(async vs => {\n    // console.log(vs)\n    await store.clear();\n    if (vs[0]) {\n        _WIDTH = vs[0].width;\n        _HEIGHT = vs[0].height;\n        _SCALE = vs[0].scale;\n        if (outputVideo && outputVideo.src) (outputVideo.src = vs[0].outputVideo) && outputVideo.play();\n        let ds = (vs[0].videos || []);\n        ds = ds.sort((a, b) => a.index - b.index);\n        for (let i = 0; i < ds.length; i++) {\n            videos[ds[i].id] = ds[i];\n            if (ds[i].type === 'audio') {\n                await baseAddBackgroundAudio(ds[i]);\n            } else {\n                await baseAddVideo(ds[i]);\n            };\n            videoObjId = ds[i].id;\n        };\n        _save();\n    }\n});\n// videos object转array\nfunction videos2array() {\n    let vs = [];\n    for (let id in videos) {\n        vs.push(videos[id])\n    };\n    vs = vs.sort((a, b) => a.index - b.index);\n    return vs;\n}\n// 保存\nfunction _save() {\n    let vs = videos2array();\n    store.set(storeKey, {\n        videos: vs,\n        width: _WIDTH,\n        height: _HEIGHT,\n        scale: _SCALE,\n        outputVideo: outputVideo && outputVideo.src && outputVideo.src.match('.mp4') ? outputVideo.src : null\n    });\n}\n\n",
  "code_length": 142,
  "size": [
    682,
    790
  ],
  "extname": "designlabplugin",
  "version": "0.1.1",
  "package_id": "da275eb97f4f1179adcab808d4286ccebfa628da",
  "create_time": 1614416557176
}